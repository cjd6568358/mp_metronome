var t=require("../../@babel/runtime/helpers/defineProperty"),e=require("../../D2781B611874D7CFB41E7366F1A8C176.js"),a=require("../../0C1254531874D7CF6A743C545888C176.js"),o=getApp();Page({data:{platform:"",darkMode:"2",darkTheme:"dark",theme:o.globalData.theme,statusBar:o.globalData.statusBar,customBar:o.globalData.customBar,navBarHeight:o.globalData.navBarHeight,userInfo:{},showPaySuccDialog:!1,goodsList:[],activeGoodsId:0,activeGoodsType:0,shippingType:0,address:"",addressInputFocus:!1,deliveryName:"",deliveryNameInputFocus:!1,mobile:"",mobileInputFocus:!1,pics:[],goodsPrice:0,totalPrice:0,shippingPrice:0,refreshUserInfo:0,promoDiscount:0,promoDiscountEnd:"",promoDiscountCountDown:""},onLoad:function(t){var e=this;e.initWatchListener(),wx.onThemeChange((function(t){"0"==o.globalData.darkMode&&(o.globalData.darkTheme=t.theme,e.setData({darkTheme:t.theme}),console.log("changetheme:",t.theme))}))},onShow:function(){var t,i,n,s=this;if(s.setData({platform:o.globalData.platform,promoDiscount:o.globalData.promoDiscount,promoDiscountEnd:o.globalData.promoDiscountEnd}),console.log("==platform==",this.data.platform),s.data.promoDiscountEnd)setInterval((function(){s.promoCountDown()}),1e3);s.refreshUserInfo(),0==s.data.activeGoodsId&&e.request(a.vipDetail,{},"GET").then((function(e){200==e.code&&(e.data.vip.forEach((function(e,a){e.priceInt=parseInt(e.price),e.origPriceInt=parseInt(e.orig_price),(0==a||e.is_default)&&(t=e.id,i=e.type,n=e.priceInt)})),s.setData({goodsList:e.data.vip,pics:e.data.pics,activeGoodsId:t,activeGoodsType:i,goodsPrice:n,totalPrice:s.calcPrice(t,n,s.data.shippingPrice,s.data.promoDiscount)}))}))},initWatchListener:function(){o.watch("darkMode",this.watchBack),o.watch("darkTheme",this.watchBack),o.watch("theme",this.watchBack),o.watch("refreshUserInfo",this.watchBack),o.watch("promoDiscount",this.watchBack)},watchBack:function(e,a){this.setData(t({},"".concat(e),a)),"refreshUserInfo"===e&&this.refreshUserInfo()},onShareAppMessage:function(){return o.onShareAppMessage()},onShareTimeline:function(){return o.onShareTimeline()},tapBack:function(){wx.navigateBack({delta:1})},tapGoodsItem:function(t){this.setData({activeGoodsId:t.currentTarget.dataset.id?t.currentTarget.dataset.id:1,activeGoodsType:t.currentTarget.dataset.type?t.currentTarget.dataset.type:1,goodsPrice:t.currentTarget.dataset.price,totalPrice:this.calcPrice(t.currentTarget.dataset.id,t.currentTarget.dataset.price,this.data.shippingPrice,this.data.promoDiscount)})},onShippingRadioChange:function(t){this.setData({shippingType:t.detail.value,shippingPrice:0==t.detail.value?0:10,totalPrice:this.calcPrice(this.data.activeGoodsId,this.data.goodsPrice,0==t.detail.value?0:10,this.data.promoDiscount)})},changeDeliveryNameInput:function(t){this.setData({deliveryName:t.detail.value,deliveryNameInputFocus:!1})},changeMobileInput:function(t){this.setData({mobile:t.detail.value,mobileInputFocus:!1})},changeAddressInput:function(t){this.setData({address:t.detail.value,addressInputFocus:!1})},handleLicense:function(){wx.navigateTo({url:"/pages/index/webview?page=license"})},handleContact:function(t){console.log(t.detail.path),console.log(t.detail.query)},tapPay:function(){var t=this;if(1==t.data.shippingType){if(0==t.data.deliveryName.length)return wx.showToast({title:"收件人不能为空",icon:"none",duration:1e3}),t.setData({deliveryNameInputFocus:!0}),!1;if(0==t.data.mobile.length)return wx.showToast({title:"手机号不能为空",icon:"none",duration:1e3}),t.setData({mobileInputFocus:!0}),!1;if(!/^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1})|(17[0-9]{1})|(16[0-9]{1})|(19[0-9]{1}))+\d{8})$/.test(t.data.mobile))return wx.showToast({title:"手机号有误",icon:"none",duration:1e3}),t.setData({mobileInputFocus:!0}),!1;if(0==t.data.address.length)return wx.showToast({title:"收货地址不能为空",icon:"none",duration:1e3}),t.setData({addressInputFocus:!0}),!1}wx.requestSubscribeMessage({tmplIds:["mb_9WWbLEsr78dUij0ET473JwVfiKAGWJQ1ZOoJRbHY"],complete:function(a){console.log("==subscribe==",a),e.payOrder(t.data.activeGoodsId,t.data.activeGoodsType,t.data.platform,t.data.address,t.data.mobile,t.data.deliveryName).then((function(e){t.setData({showPaySuccDialog:!0}),o.globalData.refreshUserInfo=o.globalData.refreshUserInfo+1})).catch((function(t){console.log(t),wx.showToast({title:"支付失败或取消支付",icon:"none",duration:1e3})}))}})},tapCloseSuccBtn:function(){this.setData({showPaySuccDialog:!1}),wx.switchTab({url:"/pages/index/index"})},promoCountDown:function(){var t=new Date,e=new Date(this.data.promoDiscountEnd.replace(/-/g,"/"));if(t>=e)this.setData({promoDiscountCountDown:""});else{var a=e.getTime()-t.getTime(),o=Math.floor(a/864e5),i=Math.floor(a/36e5%24),n=Math.floor(a/6e4%60),s=Math.floor(a/1e3%60);i=i>9?i:"0"+i,n=n>9?n:"0"+n,s=s>9?s:"0"+s,this.setData({promoDiscountCountDown:o?o+"天"+i+":"+n+":"+s:i+":"+n+":"+s})}},refreshUserInfo:function(){var t,o=this;e.request(a.showUser,{},"POST").then((function(e){200==e.code&&(t=e.data,wx.setStorageSync("userInfo",e.data),o.setData({userInfo:{isVip:!!t&&t.is_vip,vipExpireTime:t&&t.is_vip&&t.vip_expire_time?t.vip_expire_time.substr(0,10):""}}))}))},calcPrice:function(t,e,a,o){return e+=a,1==t?e-o/2:e-o}});