var t=require("../../@babel/runtime/helpers/defineProperty"),a=require("../../2F5D89511874D7CF493BE15645B8C176.js");Component({properties:{show:{type:Boolean,value:!1},theme:{type:String,value:"blue"},darkTheme:{type:String,value:"dark"},curIndex:{type:Number,value:0},curBar:{type:Number,value:0},beatCount:{type:Number,value:0},curSpeed:{type:Number,value:0},trainIng:{type:Boolean,value:!1}},data:{tabId:0,scrollTop:0,showSpeedInput:!1,speedInputNum:120,speedInputId:"1",speed:{t1:120,t2:120,t3:60},trainMode:"1",totalMinute:10,totalStepMinute:10,totalBar:0,leftBar:0,leftTimeSecond:0,leftTime:"",pastTimeSecond:0,nextSpeed:0,nextLeftTime:"",progress:0,plans:[{scale:50,minute:5,percent:33.3},{scale:75,minute:5,percent:33.3},{scale:100,minute:5,percent:33.3}],stepMode:0,stepBar:5,stepMinute:1,stepSpeed:1,stepTimer:null,gapBar:1,gapMinute:5},lifetimes:{show:function(){}},observers:{show:function(){this.data.trainIng||(getApp().globalData.playing||this.stopTrain(),this.updatePlans(),this.updateCost())},beatCount:function(){},curBar:function(){this.data.trainIng&&this.updateBarProgress()}},methods:{hide:function(){this.triggerEvent("hide"),console.log("====hide=====")},swithTab:function(t){this.data.trainIng||this.setData({tabId:t.currentTarget.dataset.tabid})},tapSpeedNum:function(t){console.log("tapSpeedNum",t),this.setData({showSpeedInput:!0,speedInputId:t.currentTarget.dataset.target,speedInputNum:this.data.speed["t".concat(t.currentTarget.dataset.target)]})},hideSpeedNum:function(){this.setData({showSpeedInput:!1})},saveSpeedNum:function(a){wx.vibrateShort({type:"heavy"});var e=parseInt(a.detail.currentTarget.dataset.num);e>370?wx.showToast({title:"BPM不能大于370",icon:"none"}):e<10?wx.showToast({title:"BPM不能小于10",icon:"none"}):(this.setData(t(t({},"speed.t"+a.detail.currentTarget.dataset.targetId,e),"showSpeedInput",!1)),this.updatePlans(),this.updateCost())},tapMinusBpmBtn:function(a){var e=this.data.speed["t"+a.currentTarget.dataset.target]-1;e>370||e<10||(this.setData(t({},"speed.t"+a.currentTarget.dataset.target,e)),this.updatePlans(),this.updateCost())},tapIncBpmBtn:function(a){var e=this.data.speed["t"+a.currentTarget.dataset.target]+1;e>370||e<10||(this.setData(t({},"speed.t"+a.currentTarget.dataset.target,e)),this.updatePlans(),this.updateCost())},tapMinusScaleBtn:function(a){console.log("==tapMinusScaleBtn==",a);var e=this.data.plans[a.currentTarget.dataset.target].scale;if(console.log(e),!(e<6)){e-=5;var s=parseInt(e*this.data.speed.t1/100);s<10||(this.setData(t(t({},"plans[".concat(a.currentTarget.dataset.target,"].scale"),e),"plans[".concat(a.currentTarget.dataset.target,"].speed"),s)),this.updatePlans())}},tapIncScaleBtn:function(a){console.log("==tapIncScaleBtn==",a);var e=this.data.plans[a.currentTarget.dataset.target].scale;if(console.log(e),!(e>199)){e+=5;var s=parseInt(e*this.data.speed.t1/100);s>370||(this.setData(t(t({},"plans[".concat(a.currentTarget.dataset.target,"].scale"),e),"plans[".concat(a.currentTarget.dataset.target,"].speed"),s)),this.updatePlans())}},tapMinusMinuteBtn:function(a){console.log("==tapMinusMinuteBtn==",a);var e=this.data.plans[a.currentTarget.dataset.target].minute;(e-=1)<1||(this.setData(t({},"plans[".concat(a.currentTarget.dataset.target,"].minute"),e)),this.updatePlans())},tapIncMinuteBtn:function(a){console.log("==tapIncMinuteBtn==",a);var e=this.data.plans[a.currentTarget.dataset.target].minute;(e+=1)>240||(this.setData(t({},"plans[".concat(a.currentTarget.dataset.target,"].minute"),e)),this.updatePlans())},addStep:function(){var t=this.data.plans;t.push({scale:100,minute:5}),this.setData({scrollTop:this.data.scrollTop+100,plans:t}),this.updatePlans()},removeStep:function(){var t=this.data.plans;t.length<2||(t.pop(),this.setData({scrollTop:this.data.scrollTop>100?this.data.scrollTop-100:0,plans:t}),this.updatePlans())},startTrain:function(t){var e=this;console.log("==startTrain==",e.data.plans);var s=getApp(),n=wx.getStorageSync("userInfo");if(n&&!n.is_vip)return e.handleShowVip(),e.hide(),!1;if("1"==t.currentTarget.dataset.mode)for(var r=0;r<e.data.plans.length;r++){if(e.data.plans[r].speed>370)return wx.showToast({title:"速度超过370了",icon:"error"}),!1;if(e.data.plans[r].speed<10)return wx.showToast({title:"速度不能低于10",icon:"error"}),!1}else if("2"==t.currentTarget.dataset.mode&&e.data.speed.t2==e.data.speed.t3)return wx.showToast({title:"目标速度不能与开始速度相同",icon:"none"}),!1;e.setData({trainMode:t.currentTarget.dataset.mode}),s.globalData.trainMode=t.currentTarget.dataset.mode,a.stopAudio(),s.globalData.playing=0,a.endInterval(),a.resetItems(),s.globalData.trainCurIndex=0,s.globalData.trainCurBar=0,s.globalData.trainTotalBar=e.data.totalBar;var i=0,p=0;"1"==t.currentTarget.dataset.mode?(s.globalData.bpmSpeed=e.data.plans[0].speed,this.updatePlans()):"2"==t.currentTarget.dataset.mode?(s.globalData.bpmSpeed=e.data.speed.t3,e.updateCost()):"3"==t.currentTarget.dataset.mode&&(s.globalData.playCount=1,s.globalData.muteCount=e.data.gapBar,p=(i=Math.ceil(s.globalData.bpmSpeed*e.data.gapMinute/s.globalData.tempo.length))*s.globalData.tempo.length*60/s.globalData.bpmSpeed,console.log("==totalBar===",i,p),s.globalData.trainTotalBar=i),a.updateItemDuration(),i&&(e.setData({totalBar:i,leftBar:i,leftTime:parseInt(p%60)>9?parseInt(p/60)+"'"+parseInt(p%60)+"''":parseInt(p/60)+"'0"+parseInt(p%60)+"''"}),console.log("==totalBar==",i,p)),setTimeout((function(){if(s.globalData.trainIng=1,e.setData({trainIng:1}),a.playAudio(),"2"==t.currentTarget.dataset.mode){var n=setInterval((function(){var t=e.data.leftTimeSecond-1;console.log("==timer==",t),t<=0&&clearInterval(e.data.stepTimer),1==e.data.stepMode&&e.data.pastTimeSecond>0&&e.data.pastTimeSecond%(60*e.data.stepMinute)==0&&(s.globalData.bpmSpeed=e.data.speed.t2>e.data.speed.t3?s.globalData.bpmSpeed+e.data.stepSpeed:s.globalData.bpmSpeed-e.data.stepSpeed,setTimeout((function(){a.changeBpm()}),.7*s.globalData.itemDuration)),e.setData({pastTimeSecond:e.data.pastTimeSecond+1,leftTimeSecond:t,leftTime:parseInt(t%60)>9?parseInt(t/60)+"'"+parseInt(t%60)+"''":parseInt(t/60)+"'0"+parseInt(t%60)+"''"})}),1e3);e.setData({stepTimer:n})}}),1e3)},stopTrain:function(){var t=getApp();t.globalData.playing=0,t.globalData.trainIng=0,t.globalData.playCount=2,t.globalData.muteCount=0,clearInterval(this.data.stepTimer),a.stopAudio(),a.endInterval(),a.resetItems(),this.setData({trainIng:0,leftBar:0,leftTime:""}),this.updatePlans()},updatePlans:function(){var t=this,a=getApp(),e=0,s=this.data.plans.map((function(t){return t.minute})).reduce((function(t,a){return t+a}),0),n=this.data.plans.map((function(n){return n.speed=Math.round(n.scale*t.data.speed.t1/100),n.barCount=Math.ceil(n.speed*n.minute/a.globalData.tempo.length),n.barDuration=Math.round(6e4*a.globalData.tempo.length/n.speed),n.curBar=0,n.percent=e+n.minute/s*100,e=n.percent,n})),r=n.map((function(t){return t.barCount})).reduce((function(t,a){return t+a}),0),i=60*s;this.setData({plans:n,totalMinute:s,totalBar:r,leftBar:r,leftTime:i<=0?"0'00''":parseInt(i%60)>9?parseInt(i/60)+"'"+parseInt(i%60)+"''":parseInt(i/60)+"'0"+parseInt(i%60)+"''"}),console.log("trainconfig",n,s,r)},updateCost:function(){var t=0,a=0,e=getApp();0==this.data.stepMode?a=(t=Math.abs(Math.ceil((this.data.speed.t2-this.data.speed.t3)*this.data.stepBar/this.data.stepSpeed)))*e.globalData.tempo.length*60*2/(this.data.speed.t2+this.data.speed.t3):1==this.data.stepMode&&(a=Math.abs((this.data.speed.t2-this.data.speed.t3)*this.data.stepMinute*60/this.data.stepSpeed),t=Math.ceil((this.data.speed.t2+this.data.speed.t3)*a/(60*e.globalData.tempo.length*2))),console.log("==updateCost==",t,a),this.setData({totalBar:t,leftBar:t,totalStepMinute:Math.ceil(a/60),leftTimeSecond:a,leftTime:parseInt(a%60)>9?parseInt(a/60)+"'"+parseInt(a%60)+"''":parseInt(a/60)+"'0"+parseInt(a%60)+"''"})},switchStepMode:function(t){this.setData({stepMode:t.detail.value}),this.updateCost()},updateBarProgress:function(){var e=this,s=getApp();if(console.log("==progress trainMode==",this.data.trainMode),"1"==this.data.trainMode){var n=this.data.plans.map((function(t,a){return e.data.curIndex>a?0:(console.log("==curIndex===",e.data.curIndex,t.barCount,t.curBar),(t.barCount-t.curBar)*t.barDuration/1e3)})).reduce((function(t,a){return t+a}),0),r=(this.data.plans["".concat(this.data.curIndex)].barCount-this.data.plans["".concat(this.data.curIndex)].curBar)*this.data.plans["".concat(this.data.curIndex)].barDuration/1e3+1;if(this.setData(t({leftTime:n<=0?"0'00''":parseInt(n%60)>9?parseInt(n/60)+"'"+parseInt(n%60)+"''":parseInt(n/60)+"'0"+parseInt(n%60)+"''",leftBar:this.data.totalBar>=this.data.curBar?this.data.totalBar-this.data.curBar:0,progress:(60*this.data.totalMinute-n)/(60*this.data.totalMinute)*100,nextSpeed:this.data.curIndex<this.data.plans.length-1?this.data.plans["".concat(this.data.curIndex+1)].speed:this.data.plans["".concat(this.data.plans.length-1)].speed,nextLeftTime:this.data.curIndex<this.data.plans.length-1?parseInt(r/60)+"'"+parseInt(r%60)+"''":""},"plans[".concat(this.data.curIndex,"].curBar"),this.data.plans["".concat(this.data.curIndex)].curBar+1)),console.log("==updateBarProgress==",this.data.leftTime,this.data.leftBar,this.data.progress,this.data.nextSpeed,this.data.nextLeftTime),this.data.plans["".concat(this.data.curIndex)].curBar==this.data.plans["".concat(this.data.curIndex)].barCount){var i=this.data.curIndex+1;i<=this.data.plans.length-1?(s.globalData.trainCurIndex=i,s.globalData.bpmSpeed=this.data.plans["".concat(i)].speed,setTimeout((function(){a.changeBpm()}),.7*s.globalData.itemDuration),console.log("===update speed==",this.data.plans["".concat(i)].speed)):(this.hide(),wx.showToast({title:"完成训练",icon:"success",duration:1e3}),setTimeout((function(){e.stopTrain()}),1e3))}}else if("2"==this.data.trainMode){var p=0;0==this.data.stepMode?(this.data.curBar>0&&this.data.curBar%this.data.stepBar==0&&(s.globalData.bpmSpeed=this.data.speed.t2>this.data.speed.t3?s.globalData.bpmSpeed+this.data.stepSpeed:s.globalData.bpmSpeed-this.data.stepSpeed,setTimeout((function(){a.changeBpm()}),.7*s.globalData.itemDuration)),p=(this.data.totalBar-this.data.curBar)*s.globalData.tempo.length*60*2/(this.data.speed.t2+this.data.curSpeed),this.setData({leftBar:this.data.totalBar>=this.data.curBar?this.data.totalBar-this.data.curBar:0,leftTime:p<=0?"0'00''":parseInt(p%60)>9?parseInt(p/60)+"'"+parseInt(p%60)+"''":parseInt(p/60)+"'0"+parseInt(p%60)+"''"})):1==this.data.stepMode&&this.setData({leftBar:this.data.totalBar>=this.data.curBar?this.data.totalBar-this.data.curBar:0}),this.data.totalBar<this.data.curBar&&setTimeout((function(){e.hide(),e.stopTrain(),wx.showToast({title:"完成训练",icon:"success",duration:1e3})}),50)}else if("3"==this.data.trainMode){var o=(this.data.totalBar-this.data.curBar)*s.globalData.tempo.length*60/s.globalData.bpmSpeed;console.log("==progress lefttime==",o),this.setData({leftBar:this.data.totalBar>=this.data.curBar?this.data.totalBar-this.data.curBar:0,leftTime:o<=0?"0'00''":parseInt(o%60)>9?parseInt(o/60)+"'"+parseInt(o%60)+"''":parseInt(o/60)+"'0"+parseInt(o%60)+"''"}),this.data.totalBar<this.data.curBar&&(this.hide(),this.stopTrain(),wx.showToast({title:"完成训练",icon:"success",duration:1e3}))}},tapMinusStepBarBtn:function(t){console.log("==tapMinusStepBarBtn==",t);var a=this.data.stepBar-1;a<1||(this.setData({stepBar:a}),this.updateCost())},tapIncStepBarBtn:function(t){console.log("==tapIncStepBarBtn==",t);var a=this.data.stepBar+1;a>60||(this.setData({stepBar:a}),this.updateCost())},tapMinusStepMinuteBtn:function(t){console.log("==tapMinusStepMinuteBtn==",t);var a=this.data.stepMinute-1;a<1||(this.setData({stepMinute:a}),this.updateCost())},tapIncStepMinuteBtn:function(t){console.log("==tapIncStepMinuteBtn==",t);var a=this.data.stepMinute+1;a>30||(this.setData({stepMinute:a}),this.updateCost())},tapMinusStepBpmBtn:function(t){console.log("==tapMinusStepBpmBtn==",t);var a=this.data.stepSpeed-1;a<1||(this.setData({stepSpeed:a}),this.updateCost())},tapIncStepBpmBtn:function(t){console.log("==tapIncStepBpmBtn==",t);var a=this.data.stepSpeed+1;a>50||(this.setData({stepSpeed:a}),this.updateCost())},tapMinusGapBarBtn:function(t){console.log("==tapMinusGapBarBtn==",t);var a=this.data.gapBar-1;a<1||this.setData({gapBar:a})},tapIncGapBarBtn:function(t){console.log("==tapIncGapBarBtn==",t);var a=this.data.gapBar+1;a>10||this.setData({gapBar:a})},tapMinusGapMinuteBtn:function(t){console.log("==tapMinusGapMinuteBtn==",t);var a=this.data.gapMinute-1;a<1||this.setData({gapMinute:a})},tapIncGapMinuteBtn:function(t){console.log("==tapIncGapMinuteBtn==",t);var a=this.data.gapMinute+1;a>240||this.setData({gapMinute:a})},handleShowVip:function(){wx.navigateTo({url:"/pages/vip/index"})}}});