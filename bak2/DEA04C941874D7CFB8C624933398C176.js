var e=require("@babel/runtime/helpers/regeneratorRuntime.js"),n=require("@babel/runtime/helpers/asyncToGenerator.js");!function(){var t=null,a=new Set;try{"function"==typeof wx.createWebAudioContext&&wx.canIUse("createWebAudioContext")&&(t=wx.createWebAudioContext())}catch(e){getApp().globalData.innerMode=!0,wx.setStorageSync("innerMode",!0),console.log("init webAudio error",e)}module.exports={initAllAudioBuffer:function(){var t=arguments,a=this;return new Promise((function(o,r){var i=getApp(),u=t.length>1&&void 0!==t[0]?t[0]:0,c=t.length>1&&void 0!==t[1]?t[1]:0;if(console.log("==isByTone=",u,c),u){var l=[];return(i.globalData.toneAudios.length<2||!i.globalData.toneAudios[c])&&r(),new Promise((function(e){e()})).then(n(e().mark((function n(){var t,r,u;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=0;case 1:if(!(t<i.globalData.toneAudios[c].count)){e.next=8;break}return r=i.globalData.toneAudios[c].files["tone_"+(t+1)],e.next=5,a.loadAudio(r).then((function(e){l["tone_"+(t+1)]=e}));case 5:t++,e.next=1;break;case 8:if(i.globalData.toneAudios[c].buffers=l,!(c>0)){e.next=20;break}u=[],t=0;case 12:if(!(t<i.globalData.toneAudios[0].count)){e.next=19;break}return r=i.globalData.toneAudios[0].files["tone_"+(t+1)],e.next=16,a.loadAudio(r).then((function(e){u["tone_"+(t+1)]=e}));case 16:t++,e.next=12;break;case 19:i.globalData.toneAudios[0].buffers=u;case 20:o(l);case 21:case"end":return e.stop()}}),n)}))))}return console.log("==AllTone="),new Promise((function(e){e()})).then(n(e().mark((function n(){var t,u,c,l;return e().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:t=e().mark((function n(){var t;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],(i.globalData.toneAudios.length<2||!getApp().globalData.toneAudios[l])&&r(),u=0;case 3:if(!(u<i.globalData.toneAudios[l].count)){e.next=11;break}return c=i.globalData.toneAudios[l].files["tone_"+(u+1)],e.next=7,a.loadAudio(c).then((function(e){t["tone_"+(u+1)]=e}));case 7:console.log("==tone buffer ready=",l);case 8:u++,e.next=3;break;case 11:i.globalData.toneAudios[l].buffers=t,o(t);case 13:case"end":return e.stop()}}),n)})),l=0;case 2:if(!(l<i.globalData.toneAudios.length)){n.next=7;break}return n.delegateYield(t(),"t0",4);case 4:l++,n.next=2;break;case 7:case"end":return n.stop()}}),n)})))).then((function(e){i.globalData.toneAudios[c].buffers=e,o()}))}))},loadAudio:function(e){return new Promise((function(n,a){wx.request({url:e,responseType:"arraybuffer",success:function(e){var o=e.data;t.decodeAudioData(o,(function(e){n(e)}),(function(e){a(e)}))},fail:function(e){a(e)}})}))},playBuffer:function(e){var n=t.createBufferSource();n.loop=!0,n.buffer=e,n.connect(t.destination),a.add(n),n.onended=function(){a.delete(n)},n.start()},stop:function(){a.forEach((function(e){e.stop()})),a.clear()},emptyBuffer:function(e){var n=t.sampleRate*e;return t.createBuffer(2,n,t.sampleRate)},clipAudio:function(e,n){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;a=a>0?a:0;for(var o=e.numberOfChannels,r=e.sampleRate,i=r*n,u=t.createBuffer(o,i-a,r),c=new Float32Array(i-a),l=0,s=0;s<o;s++)e.copyFromChannel(c,s,r*a),u.copyToChannel(c,s,l);return u},concatAudio:function(e){var n=t.sampleRate,a=e&&e[0]?e[0].numberOfChannels:2,o=function(e){return e.map((function(e){return e.length})).reduce((function(e,n){return e+n}),0)}(e);if(!(o<=0)){var r=t.createBuffer(a,o,n),i=0;return e.forEach((function(e){for(var n=0;n<e.numberOfChannels;n++)r.getChannelData(n).set(e.getChannelData(n),i);i+=e.length})),r}},audioBufferToWav:function(e,n){n=n||{};var t,a=e.numberOfChannels,o=e.sampleRate,r=n.float32?3:1,i=3===r?32:16;return t=2===a?function(e,n){var t=e.length+n.length,a=new Float32Array(t),o=0,r=0;for(;o<t;)a[o++]=e[r],a[o++]=n[r],r++;return a}(e.getChannelData(0),e.getChannelData(1)):e.getChannelData(0),new Promise((function(e,n){e(function(e,n,t,a,o){var r=o/8,i=a*r,c=new ArrayBuffer(44+e.length*r),l=new DataView(c);u(l,0,"RIFF"),l.setUint32(4,36+e.length*r,!0),u(l,8,"WAVE"),u(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,n,!0),l.setUint16(22,a,!0),l.setUint32(24,t,!0),l.setUint32(28,t*i,!0),l.setUint16(32,i,!0),l.setUint16(34,o,!0),u(l,36,"data"),l.setUint32(40,e.length*r,!0),1===n?function(e,n,t){for(var a=0;a<t.length;a++,n+=2){var o=Math.max(-1,Math.min(1,t[a]));e.setInt16(n,o<0?32768*o:32767*o,!0)}}(l,44,e):function(e,n,t){for(var a=0;a<t.length;a++,n+=4)e.setFloat32(n,t[a],!0)}(l,44,e);return c}(t,r,o,a,i))}));function u(e,n,t){for(var a=0;a<t.length;a++)e.setUint8(n+a,t.charCodeAt(a))}},saveAudioToFile:function(e,n){return new Promise((function(t,a){var o=wx.getFileSystemManager(),r=getApp();try{o.accessSync(n)&&o.unlinkSync(n)}catch(e){}o.writeFile({filePath:n,data:e,encoding:"binary",success:function(e){r.globalData.playerReady=!0,t(e)},fail:function(e){a(e)}})}))}}}();